import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.7b60570d.js";const p="/portal/images/linux/nginx-location.png",e="/portal/images/linux/cachecontrol.png",u=JSON.parse('{"title":"nginx 知识整理","description":"","frontmatter":{},"headers":[],"relativePath":"workflow/devops/nginx.md","lastUpdated":1705323905000}'),o={name:"workflow/devops/nginx.md"},t=l(`<h1 id="nginx-知识整理" tabindex="-1">nginx 知识整理 <a class="header-anchor" href="#nginx-知识整理" aria-label="Permalink to &quot;nginx 知识整理&quot;">​</a></h1><blockquote><p>学习掌握好 <code>nginx</code></p></blockquote><h2 id="一、初识-nginx" tabindex="-1">一、初识 nginx <a class="header-anchor" href="#一、初识-nginx" aria-label="Permalink to &quot;一、初识 nginx&quot;">​</a></h2><h3 id="_1-1、安装" tabindex="-1">1.1、安装 <a class="header-anchor" href="#_1-1、安装" aria-label="Permalink to &quot;1.1、安装&quot;">​</a></h3><p>以 centos 为例，通过 yum 进行安装</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 安装nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看安装的版本</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看编译时的参数</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-V</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_1-2、操作" tabindex="-1">1.2、操作 <a class="header-anchor" href="#_1-2、操作" aria-label="Permalink to &quot;1.2、操作&quot;">​</a></h3><p><strong>命令</strong></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">option</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx.server</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>option</strong></p><ul><li><code>start</code>: 启动</li><li><code>stop</code>: 停止</li><li><code>status</code>: 状态</li><li><code>restart</code>: 重启</li><li><code>reload</code>: 重新读取配置</li></ul><h3 id="_1-3、配置文件" tabindex="-1">1.3、配置文件 <a class="header-anchor" href="#_1-3、配置文件" aria-label="Permalink to &quot;1.3、配置文件&quot;">​</a></h3><p>上面安装的 nginx 版本为 <code>nginx/1.20.1</code>，以此为例，nginx 配置文件如下</p><ul><li><p><code>/etc/nginx/nginx.conf</code>: 主配置文件</p></li><li><p><code>/etc/nginx/conf.d/*.conf</code>: 包含<code>conf.d</code>目录下面的所有配置文件</p></li><li><p><code>/etc/nginx/default.d/*.conf</code>: 包含<code>default.d</code>目录下面的所有配置文件</p></li></ul><p><strong><code>nginx</code>配置语法</strong></p><p>主配置文件 <code>/etc/nginx/nginx.conf</code> 配置如下</p><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 全局配置</span></span>
<span class="line"><span style="color:#89DDFF;">user </span><span style="color:#A6ACCD;">nginx</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># user: 设置nginx服务的系统使用用户</span></span>
<span class="line"><span style="color:#89DDFF;">worker_processes </span><span style="color:#A6ACCD;">auto</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 工作进程数,一般和CPU数量相同</span></span>
<span class="line"><span style="color:#89DDFF;">error_log </span><span style="color:#A6ACCD;">/var/log/nginx/error.log</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># nginx的错误日志</span></span>
<span class="line"><span style="color:#89DDFF;">pid </span><span style="color:#A6ACCD;">/run/nginx.pid</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># nginx服务启动时的pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span></span>
<span class="line"><span style="color:#89DDFF;">include </span><span style="color:#A6ACCD;">/usr/share/nginx/modules/*.conf</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 事件配置</span></span>
<span class="line"><span style="color:#C792EA;">events</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> worker_connections </span><span style="color:#A6ACCD;">1024</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 每个进程允许的最大连接数</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># http 配置</span></span>
<span class="line"><span style="color:#C792EA;">http</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> log_format  main</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_addr</span><span style="color:#C3E88D;"> - </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_user</span><span style="color:#C3E88D;"> [</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">time_local</span><span style="color:#C3E88D;">] &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request</span><span style="color:#C3E88D;">&quot; &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">status</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">body_bytes_sent</span><span style="color:#C3E88D;"> &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_referer</span><span style="color:#C3E88D;">&quot; &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">&#39;&quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_user_agent</span><span style="color:#C3E88D;">&quot; &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_x_forwarded_for</span><span style="color:#C3E88D;">&quot;&#39;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 日志记录格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;"> /var/log/nginx/access.log </span><span style="color:#89DDFF;"> main;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 默认访问日志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> sendfile </span><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;"> on;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 启动 sendfile</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> tcp_nopush </span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;"> on;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># tcp_nopush: 懒发送</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> tcp_nodelay </span><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> on;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> keepalive_timeout </span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">65</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> types_hash_max_size </span><span style="color:#A6ACCD;">4096</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">            /etc/nginx/mime.types</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 文件后缀和类型类型的对应关系</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> default_type </span><span style="color:#A6ACCD;">       application/octet-stream</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 默认content-type</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">/etc/nginx/conf.d/*.conf</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 包含的子配置文件</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># server 配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 监听端口</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">      [::]:80</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> server_name </span><span style="color:#A6ACCD;"> _</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 用域名方式访问的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">        /usr/share/nginx/html</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 静态文件根目录</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/usr/share/nginx/html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;"> index </span><span style="color:#A6ACCD;">index.html index.htm</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 首页的索引文件</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> error_page </span><span style="color:#A6ACCD;">404 /404.html</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 指定错误页面 🙅‍♂️</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/404.html </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> error_page </span><span style="color:#A6ACCD;">500 </span><span style="color:#F78C6C;">502</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">503</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">504</span><span style="color:#A6ACCD;"> /50x.html</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 把后台错误重定向到静态的50x.html页面</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/50x.html </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><ul><li>配置文件由 <strong>指令</strong> 与 <strong>指令块</strong> 组成,指令块以<code>{}</code>将多条指令组织在一起</li><li>每条指令以 <strong><code>;</code>(分号)</strong> 结尾，指令与参数之间以空格分隔</li><li><code>include</code> 语句允许把多个配置文件组合起来以提升可维护性</li><li>一个<code>http</code>下面可以配置多个 <code>server</code>, 一个 <code>server</code> 下面可以配置多个 <code>location</code></li></ul><h2 id="二、nginx-工作流" tabindex="-1">二、nginx 工作流 <a class="header-anchor" href="#二、nginx-工作流" aria-label="Permalink to &quot;二、nginx 工作流&quot;">​</a></h2><h2 id="三、nginx-语法" tabindex="-1">三、nginx 语法 <a class="header-anchor" href="#三、nginx-语法" aria-label="Permalink to &quot;三、nginx 语法&quot;">​</a></h2><h3 id="_3-1、location" tabindex="-1">3.1、location <a class="header-anchor" href="#_3-1、location" aria-label="Permalink to &quot;3.1、location&quot;">​</a></h3><p><code>location</code> 会用来匹配 <code>URI</code>，但会忽略其中的参数</p><p><strong>正则表达式</strong></p><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>.</code></td><td>匹配除换行符之外的任意字符</td></tr><tr><td><code>?</code></td><td>重复 0 次或 1 次</td></tr><tr><td><code>+</code></td><td>重复 1 次或更多次</td></tr><tr><td><code>*</code></td><td>重复 0 次或多次</td></tr><tr><td><code>^</code></td><td>匹配字符串的开始</td></tr><tr><td><code>$</code></td><td>匹配字符串的结束</td></tr><tr><td><code>{n}</code></td><td>重复 n 次</td></tr><tr><td><code>{n,}</code></td><td>重复 n 次或更多次</td></tr><tr><td><code>[abc]</code></td><td>匹配单个字符 a 或者 b 或者 c</td></tr><tr><td><code>a-z</code></td><td>匹配 a-z 小写字母的任意一个</td></tr><tr><td><code>\\</code></td><td>转义字符</td></tr><tr><td><code>()</code></td><td>分组，用于匹配括号之间的内容，可以通过$1、$2 引用</td></tr><tr><td><code>\\w</code></td><td>指包含大 小写字母数字和下划线 相当于(<code>[0-9a-zA-Z]</code>)</td></tr></tbody></table><p><strong>语法规则</strong></p><ul><li>前缀匹配 <ul><li>常规</li><li><code>=</code>, 精确匹配</li><li><code>^~</code>, 匹配上后则不再继续进行正则的匹配</li></ul></li><li>正则表达式 <ul><li><code>~</code>, 大小写敏感的正则表达式匹配</li><li><code>~*</code>, 忽略大小写敏感的正则表达式匹配</li></ul></li><li>内部调转 <ul><li>用于内部跳转的命名 <code>location @xxx</code></li></ul></li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">[=|~|~*|^~] uri </span><span style="color:#A6ACCD;">{...}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">@name</span><span style="color:#A6ACCD;">{...}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>匹配规则</strong><img src="`+p+`" alt=""></p><ul><li>等号类型（=）的优先级最高</li><li>^~类型表达式的优先级次之</li><li>反之，则匹配正则表达式类型（~ ~*），如果有多个 location 的正则能匹配的话，则使用正则表达式最长的那个</li><li>最后，常规字符串匹配类型按前缀匹配</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">location ~ /T1/$ {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;匹配到第一个正则表达式&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location ~* /T1/(\\w+)$ {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;匹配到最长的正则表达式&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location ^~ /T1/ {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;停止后续的正则表达式匹配&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location  /T1/T2 {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;最长的前缀表达式匹配&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location  /T1 {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;前缀表达式匹配&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location = /T1 {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return 200 &#39;精确匹配&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">/T1     //精确匹配</span></span>
<span class="line"><span style="color:#A6ACCD;">/T1/    //停止后续的正则表达式匹配</span></span>
<span class="line"><span style="color:#A6ACCD;">/T1/T2  //匹配到最长的正则表达式</span></span>
<span class="line"><span style="color:#A6ACCD;">/T1/T2/ //最长的前缀表达式匹配</span></span>
<span class="line"><span style="color:#A6ACCD;">/t1/T2  //匹配到最长的正则表达式</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-2、rewrite" tabindex="-1">3.2、rewrite <a class="header-anchor" href="#_3-2、rewrite" aria-label="Permalink to &quot;3.2、rewrite&quot;">​</a></h3><p>通过 <code>rewrite</code> 实现 url 重写及重定向</p><p><strong>语法</strong></p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">rewrite regex replacement [flag]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>flag</strong></p><p>flag: 标识规则对应的类型</p><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>last</code></td><td>先匹配自己的 location,然后通过<code>rewrite</code>规则新建一个请求再次请求服务端</td></tr><tr><td><code>break</code></td><td>先匹配自己的 location,然后生命周期会在当前的 location 结束,不再进行后续的匹配</td></tr><tr><td><code>redirect</code></td><td>返回 302 昨时重定向,以后还会请求这个服务器</td></tr><tr><td><code>permanent</code></td><td>返回 301 永久重定向,以后会直接请求永久重定向后的域名</td></tr></tbody></table><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/break </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;"> ^/break /test </span><span style="color:#F78C6C;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/data/html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/last </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;"> ^/last /test</span><span style="color:#89DDFF;"> last;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/test </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> default_type </span><span style="color:#A6ACCD;">application/json</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">&#39;{&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;}&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/redirect </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;"> ^/redirect http://www.baidu.com </span><span style="color:#F78C6C;">redirect</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/permanent </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;"> ^/permanent http://www.baidu.com </span><span style="color:#F78C6C;">permanent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># curl http://localhost/last</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">code</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">success</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># curl http://localhost/break</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 并没有继续匹配到 \`/test\`, 而是直接终止，去 /data/html/ 目录下去匹配 test 目录</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># curl -vL http://localhost/redirect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># curl -vL http://localhost/permanent</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="四、nginx-实战" tabindex="-1">四、nginx 实战 <a class="header-anchor" href="#四、nginx-实战" aria-label="Permalink to &quot;四、nginx 实战&quot;">​</a></h2><h3 id="_4-1、静态资源-web-服务" tabindex="-1">4.1、静态资源 web 服务 <a class="header-anchor" href="#_4-1、静态资源-web-服务" aria-label="Permalink to &quot;4.1、静态资源 web 服务&quot;">​</a></h3><p><strong>静态资源</strong>: 一般客户端发送请求到 web 服务器，web 服务器从<strong>内存</strong>中取到相应的文件，返回给客户端，客户端解析并渲染显示出来</p><p><strong>CDN</strong>: 实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上</p><p><strong>配置选项</strong></p><table><thead><tr><th>配置项</th><th>含义</th><th>可选值</th><th>默认值</th><th>上下文</th></tr></thead><tbody><tr><td><strong><code>sendfile</code></strong></td><td>不经过用户内核发送文件</td><td>on/off</td><td>off</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>tcp_nopush</code></strong></td><td>在<code>sendfile</code>开启的情况下，合并多个数据包，提高网络包的传输效率</td><td>on/off</td><td>off</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>tcp_nodelay</code></strong></td><td>在<code>keepalive</code>连接下，提高网络包的传输实时性</td><td>on/off</td><td>off</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>gzip</code></strong></td><td>压缩文件可以节约带宽和提高网络传输效率类型</td><td>on/off</td><td>off</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>gzip_min_length</code></strong></td><td>最小压缩文件的大小</td><td>size</td><td></td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>gzip_comp_level</code></strong></td><td>压缩级别, 值越高，压缩的体积越小</td><td>level</td><td>1</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>gzip_http_version</code></strong></td><td>压缩版本</td><td>1.0/1.1</td><td>1.1</td><td><code>http, server, location, </code></td></tr><tr><td><strong><code>http_gzip-static_module</code></strong></td><td>先找磁盘上找同名的<code>.gz</code>这个文件是否存在,节约 CPU 的压缩时间和性能损耗</td><td>on/off</td><td>off</td><td><code>http, server, location, </code></td></tr></tbody></table><p><strong>实战</strong></p><ul><li>资源</li></ul><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/www/images</span></span>
<span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/www/html</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">color</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/www/html/color.html</span></span>
<span class="line"><span style="color:#FFCB6B;">gzip</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/www/html/color.html</span></span>
<span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/www/download</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>配置</li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.*\\.(jpg|png|gif)$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">#关闭压缩</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/data/www/images</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.*\\.(html|js|css)$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_static </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#启用压缩</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_min_length </span><span style="color:#A6ACCD;">1k</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#只压缩超过1K的文件</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_http_version </span><span style="color:#A6ACCD;">1.1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#启用gzip压缩所需的HTTP最低版本</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_comp_level </span><span style="color:#A6ACCD;">9</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">#压缩级别，压缩比率越高文件被压缩的体积越小</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_types </span><span style="color:#A6ACCD;"> text/css application/javascript</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">#进行压缩的文件类型</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/data/www/html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/download </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> gzip_static </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#启用压缩</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> tcp_nopush </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 不要着急发，攒一波再发</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/data/www</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 注意此处目录是\`/data/www\`而不是\`/data/www/download\`</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_4-2、浏览器缓存" tabindex="-1">4.2、浏览器缓存 <a class="header-anchor" href="#_4-2、浏览器缓存" aria-label="Permalink to &quot;4.2、浏览器缓存&quot;">​</a></h3><p><strong>浏览器校验本地缓存流程</strong></p><p><img src="`+e+`" alt=""></p><p>可设置的响应头</p><ul><li>Expires</li><li>Cache-Control</li><li>Etag</li><li>Last-Modified</li></ul><p><strong>设置 Expires</strong></p><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.*\\.(jpg|png|gif)$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> expires </span><span style="color:#A6ACCD;">24h</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-3、跨域" tabindex="-1">4.3、跨域 <a class="header-anchor" href="#_4-3、跨域" aria-label="Permalink to &quot;4.3、跨域&quot;">​</a></h3><p>关于什么是跨域，以及汇总的解决办法，请参考 <a href="https://yangjia23.github.io/portal-blog/frontend-graph/%E6%B5%8F%E8%A7%88%E5%99%A8/4%E3%80%81%E4%B8%80%E6%96%87%E6%B1%87%E6%80%BB9%E7%A7%8D%E8%B7%A8%E5%9F%9F%E6%96%B9%E6%B3%95.html" target="_blank" rel="noreferrer">一文汇总 9 种跨域方法</a>，在 nginx 中解决跨域，需要设置不同的响应头</p><p><strong>语法</strong></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">add_header</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">value</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>客户端</strong></p><p>在客户端通过 live-server 开启本地服务，向服务端发送请求</p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">PUBLIC</span><span style="color:#89DDFF;"> </span><span style="color:#C3E88D;">&quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> xhr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">XMLHttpRequest</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://{ip}/user.json</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onreadystatechange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">readyState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">status</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">responseText</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">      xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>服务端</strong></p><ul><li>静态资源</li></ul><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/json</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/json</span></span>
<span class="line"><span style="color:#FFCB6B;">vi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user.json</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">前端壹甲壹</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>nginx 配置</li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.*\\.json$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">Access-Control-Allow-Origin http://127.0.0.1:8080</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/data/json</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_4-4、代理" tabindex="-1">4.4、代理 <a class="header-anchor" href="#_4-4、代理" aria-label="Permalink to &quot;4.4、代理&quot;">​</a></h3><p>通过在 <code>server</code> 或 <code>location</code> 中设置 <code>proxy_pass</code> 来实现代理</p><h4 id="_4-4-1、正向代理" tabindex="-1">4.4.1、正向代理 <a class="header-anchor" href="#_4-4-1、正向代理" aria-label="Permalink to &quot;4.4.1、正向代理&quot;">​</a></h4><p>正向代理的对象是客户端,服务器端看不到真正的客户端，例如翻墙使用的 VPN</p><h4 id="_4-4-2、反向代理" tabindex="-1">4.4.2、反向代理 <a class="header-anchor" href="#_4-4-2、反向代理" aria-label="Permalink to &quot;4.4.2、反向代理&quot;">​</a></h4><p>反向代理的对象的服务端,客户端看不到真正的服务端，例如 nginx 代理的应用服务器</p><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/api </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://localhost:3000</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_redirect </span><span style="color:#A6ACCD;">default</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重定向</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_set_header </span><span style="color:#A6ACCD;">Host </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_host</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">#向后传递头信息</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_set_header </span><span style="color:#A6ACCD;">X-Real-IP </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_addr</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#把真实IP传给应用服务器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_connect_timeout </span><span style="color:#A6ACCD;">30</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#默认超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_send_timeout </span><span style="color:#A6ACCD;">60</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 发送超时</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_read_timeout </span><span style="color:#A6ACCD;">60</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 读取超时</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong><code>proxy_pass</code></strong></p><ul><li><code>proxy_pass</code> 后的 <code>url</code> 最后加上 <code>/</code> 就是绝对根路径, <code>location</code> 中匹配的路径部分不走代理,也就是说会被替换掉</li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/a/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://127.0.0.1/b/</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 请求 http://example.com/a/test.html, 会被代理到 http://127.0.0.1/b/test.html</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>proxy_pass</code> 后的 <code>url</code> 最后没有 <code>/</code> 就是相对路径，<code>location</code> 中匹配的路径部分会走代理,也就是说会保留</li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/a/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://127.0.0.1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 请求 http://example.com/a/test.html, 会被代理到 http://127.0.0.1/a/test.html</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>(PS: 为了方便记忆和规范配置，建议所有的 <code>proxy_pass</code> 后的<code>url</code>都以<code>/</code>结尾 )</p><ul><li>在<code>proxy_pass</code>前面用了<code>rewrite</code>，如下，这种情况下，<code>proxy_pass</code>是无效的</li></ul><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/getName/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;">    /getName/([</span><span style="color:#C3E88D;">^/]+) /users?name=$</span><span style="color:#A6ACCD;">1 </span><span style="color:#F78C6C;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://127.0.0.1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-5、负载均衡" tabindex="-1">4.5、负载均衡 <a class="header-anchor" href="#_4-5、负载均衡" aria-label="Permalink to &quot;4.5、负载均衡&quot;">​</a></h3><p>当网站出行高并发，访问量大时，一台服务器的处理能力、存储空间不足时，应该增加一台服务器去分担网站的访问及存储压力。</p><p>通过负载均衡调度服务器，将所有的访问请求分发到应用服务器集群中的任何一台服务器上，当有更多的访问，就在集群中加入更多的应用服务器</p><h4 id="_4-5-1、upstream" tabindex="-1">4.5.1、upstream <a class="header-anchor" href="#_4-5-1、upstream" aria-label="Permalink to &quot;4.5.1、upstream&quot;">​</a></h4><p>通过 <code>upstream</code> 定义一组服务池，nginx 把请求转发到服务池</p><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">webServer </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:4000;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:5000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-5-2、后端服务器调试状态" tabindex="-1">4.5.2、后端服务器调试状态 <a class="header-anchor" href="#_4-5-2、后端服务器调试状态" aria-label="Permalink to &quot;4.5.2、后端服务器调试状态&quot;">​</a></h4><table><thead><tr><th>状态</th><th>描述</th></tr></thead><tbody><tr><td><strong><code>down</code></strong></td><td>当前服务器不参与负载均衡</td></tr><tr><td><strong><code>backup</code></strong></td><td>当其它节点都无法使用时的备份服务器</td></tr><tr><td><strong><code>max_fails</code></strong></td><td>允许请求失败的次数, 到达最大次数就会休眠</td></tr><tr><td><strong><code>fail_timeout</code></strong></td><td>经过 max_fails 失败后，服务器休眠时间,默认 10 秒</td></tr><tr><td><strong><code>max_conns</code></strong></td><td>当前服务器可接收的最大连接数</td></tr></tbody></table><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">webServer </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000 down; </span><span style="color:#676E95;font-style:italic;">#不参与负载均衡</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:4000 backup; </span><span style="color:#676E95;font-style:italic;">#充当备份服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:5000 ;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-5-2、分配方式" tabindex="-1">4.5.2、分配方式 <a class="header-anchor" href="#_4-5-2、分配方式" aria-label="Permalink to &quot;4.5.2、分配方式&quot;">​</a></h4><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>轮询(默认)</td><td><strong>平均主义</strong>, 每个请求按时间顺序逐一分配到不同的后端服务器，当某个服务器 down 掉，会被自动剔除</td></tr><tr><td><strong><code>weight</code></strong></td><td><strong>加权轮询</strong>，通过<code>weight</code>指定轮询几率，<code>weight</code>和访问比率成正比</td></tr><tr><td><strong><code>ip_hash</code></strong></td><td>每个请求按访问<code>ip</code>的<code>hash</code>结果分配, 每个访客固定访问一个后端服务器，可以解决<code>session</code> 的问题</td></tr><tr><td><strong><code>least_conn</code></strong></td><td>哪个机器上连接数少就分发给谁</td></tr><tr><td><strong><code>url_hash</code></strong></td><td>按访问的<code>URL</code>地址来分配 请求，每个<code>URL</code>都定向到同一个后端服务器上(缓存)。(ps: <em>第三方</em>）</td></tr><tr><td><strong><code>fair</code></strong></td><td>按后端服务器的响应时间来分配请求，响应时间短的优先分配。（ps: <em>第三方</em>）</td></tr></tbody></table><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># weight</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">webServer </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000 </span><span style="color:#A6ACCD;font-style:italic;">weight</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  server 127.0.0.1:4000 </span><span style="color:#A6ACCD;font-style:italic;">weight</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  server 127.0.0.1:5000 </span><span style="color:#A6ACCD;font-style:italic;">weight</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-nginx line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># ip_hash</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">webServer </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">ip_hash</span><span style="color:#A6ACCD;"> # [type], type = ip_hash | least_conn | url_hash | fair</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div>`,98),r=[t];function c(i,y,C,D,d,A){return n(),a("div",null,r)}const F=s(o,[["render",c]]);export{u as __pageData,F as default};
